name: OCV PR:4.x RISC-V native

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/OCV-PR-4.x-RISCV-native.yaml'
  workflow_call:

concurrency:
  group: OCV-PR-4.x-RISCV-${{ github.ref }}
  cancel-in-progress: true

env:
  # 移除交叉编译工具链，因为我们在原生RISC-V环境
  EXTRA_CMAKE_OPTIONS: '-DBUILD_EXAMPLES=ON -DOPENCV_ENABLE_NONFREE=ON -DCPU_BASELINE=RVV -DCPU_BASELINE_REQUIRE=RVV -DRISCV_RVV_SCALABLE=ON'
  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
  PR_AUTHOR_FORK: ${{ github.event.pull_request.head.repo.full_name }}
  SOURCE_BRANCH_NAME: ${{ github.head_ref }}
  TARGET_BRANCH_NAME: ${{ github.base_ref }}
  CCACHE_DIR: '/tmp/.ccache'
  OPENCV_DOWNLOAD_PATH: '/tmp/binaries_cache'
  OPENCV_TEST_DATA_PATH: '/tmp/opencv_extra/testdata'
  OPENCV_CONTRIB_DOCKER_WORKDIR: '/tmp/opencv_contrib'
  OPENCV_DOCKER_WORKDIR: '/tmp/opencv'
  PYTHONPATH: '/tmp/build/python_loader:$PYTHONPATH'
  # 移除QEMU，因为我们在原生RISC-V环境运行
  TEST_RUNNER: ''
  GIT_COMMITTER_NAME: 'nouser'
  GIT_COMMITTER_EMAIL: 'noemail'

jobs:
  BuildAndTest:
    # 改为自托管运行器
    runs-on: [self-hosted, riscv64, linux]

    defaults:
      run:
        shell: bash

    # 移除Docker容器配置
    steps:
    - name: Install prerequisites
      timeout-minutes: 30
      run: |
        sudo apt-get update || true
        # 安装OpenCV编译依赖
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          cmake \
          ninja-build \
          ccache \
          git \
          wget \
          unzip \
          python3 \
          python3-dev \
          python3-numpy \
          libgtk2.0-dev \
          pkg-config \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev \
          libtbb-dev \
          libeigen3-dev \
          libopenblas-dev \
          liblapack-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer1.0-dev \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          libopenexr-dev \
          libwebp-dev \
          libopenjp2-7-dev \
          libgtk-3-dev

    - name: Brief system information
      timeout-minutes: 5
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== CPU Information ==="
        cat /proc/cpuinfo
        echo "=== Memory Information ==="
        free -h
        echo "=== Disk Information ==="
        df -h

    - name: Setup environment
      timeout-minutes: 5
      run: |
        mkdir -p ${{ env.CCACHE_DIR }}
        mkdir -p ${{ env.OPENCV_DOWNLOAD_PATH }}
        mkdir -p ${{ env.OPENCV_DOCKER_WORKDIR }}
        mkdir -p ${{ env.OPENCV_CONTRIB_DOCKER_WORKDIR }}

    - name: Setup infra environment
      timeout-minutes: 5
      if: ${{ github.event.repository.name == 'ci-gha-workflow' }}
      run: |
        echo "TARGET_BRANCH_NAME=4.x" >> $GITHUB_ENV

    - name: Setup test environment
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        echo "EXTRA_GTEST_OPTIONS=--skip_unstable=1" >> $GITHUB_ENV

    - name: PR info
      timeout-minutes: 5
      run: |
        echo "PR Author: ${{ env.PR_AUTHOR }}"
        echo "PR Author fork: ${{ env.PR_AUTHOR_FORK }}"
        echo "Source branch name: ${{ env.SOURCE_BRANCH_NAME }}"
        echo "Target branch name: ${{ env.TARGET_BRANCH_NAME }}"

    - name: Clean workspace
      timeout-minutes: 5
      run: |
        rm -rf ${{ env.OPENCV_DOCKER_WORKDIR }}/*

    - name: Checkout OpenCV
      uses: actions/checkout@v4
      with:
        repository: zqb-all/opencv
        ref: ${{ env.TARGET_BRANCH_NAME }}
        path: ${{ env.OPENCV_DOCKER_WORKDIR }}

    - name: Merge with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd ${{ env.OPENCV_DOCKER_WORKDIR }}
        git remote add upstream "https://github.com/${{ env.PR_AUTHOR_FORK }}.git"
        git fetch upstream ${{ env.SOURCE_BRANCH_NAME }}
        git merge --no-commit --no-ff upstream/${{ env.SOURCE_BRANCH_NAME }}

    - name: Checkout OpenCV extra
      uses: actions/checkout@v4
      with:
        repository: opencv/opencv_extra
        ref: ${{ env.TARGET_BRANCH_NAME }}
        path: ${{ env.OPENCV_TEST_DATA_PATH }}

    - name: Merge opencv_extra with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        if curl -s -I "https://github.com/${{ env.PR_AUTHOR }}/opencv_extra" | head -n 1 | grep -q "200"; then
          cd ${{ env.OPENCV_TEST_DATA_PATH }}
          git remote add upstream "https://github.com/${{ env.PR_AUTHOR }}/opencv_extra.git"
          git fetch upstream ${{ env.SOURCE_BRANCH_NAME }}
          git merge --no-commit --no-ff upstream/${{ env.SOURCE_BRANCH_NAME }} 2>/dev/null || echo "No matching branch in opencv_extra"
        else
          echo "opencv_extra fork not found for PR author"
        fi

    - name: Configure OpenCV
      timeout-minutes: 30
      run: |
        mkdir -p /tmp/build
        cd /tmp/build
        cmake -G Ninja \
          -S ${{ env.OPENCV_DOCKER_WORKDIR }} \
          -B . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DBUILD_PERF_TESTS=ON \
          -DWITH_OPENCL=OFF \
          -DWITH_CUDA=OFF \
          ${{ env.EXTRA_CMAKE_OPTIONS }}

    - name: Build OpenCV
      timeout-minutes: 120
      id: build-opencv
      run: |
        cd /tmp/build
        ninja -j$(nproc) 2>&1 | tee build-log.txt

    - name: Warnings check
      timeout-minutes: 10
      run: |
        if [ -f /tmp/build/build-log.txt ]; then
          grep -i "warning:" /tmp/build/build-log.txt | head -20 || true
        fi

    - name: Accuracy:core
      timeout-minutes: 90
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd /tmp/build
        ./bin/opencv_test_core \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*

    - name: Accuracy:imgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd /tmp/build
        ./bin/opencv_test_imgproc \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*:-Imgproc_Hist_Compare.accuracy

    - name: Accuracy:dnn
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd /tmp/build
        ./bin/opencv_test_dnn \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*

  BuildContrib:
    # 改为自托管运行器
    runs-on: [self-hosted, riscv64, linux]

    defaults:
      run:
        shell: bash

    steps:
    - name: Install prerequisites
      timeout-minutes: 30
      run: |
        sudo apt-get update || true
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          cmake \
          ninja-build \
          ccache \
          git \
          wget \
          unzip \
          python3 \
          python3-dev \
          python3-numpy \
          libgtk2.0-dev \
          pkg-config \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev

    - name: Brief system information
      timeout-minutes: 5
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== CPU Information ==="
        cat /proc/cpuinfo
        echo "=== Memory Information ==="
        free -h

    - name: Setup environment
      timeout-minutes: 5
      run: |
        mkdir -p /tmp/.ccache
        mkdir -p /tmp/opencv
        mkdir -p /tmp/opencv_contrib
        mkdir -p /tmp/build

    - name: Setup infra environment
      timeout-minutes: 5
      if: ${{ github.event.repository.name == 'ci-gha-workflow' }}
      run: |
        echo "TARGET_BRANCH_NAME=4.x" >> $GITHUB_ENV

    - name: PR info
      timeout-minutes: 5
      run: |
        echo "PR Author: ${{ env.PR_AUTHOR }}"
        echo "PR Author fork: ${{ env.PR_AUTHOR_FORK }}"
        echo "Source branch name: ${{ env.SOURCE_BRANCH_NAME }}"
        echo "Target branch name: ${{ env.TARGET_BRANCH_NAME }}"

    - name: Clean workspace
      timeout-minutes: 5
      run: |
        rm -rf /tmp/opencv/*

    - name: Checkout OpenCV
      uses: actions/checkout@v4
      with:
        repository: zqb-all/opencv
        ref: ${{ env.TARGET_BRANCH_NAME }}
        path: /tmp/opencv

    - name: Merge with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd /tmp/opencv
        git remote add upstream "https://github.com/${{ env.PR_AUTHOR_FORK }}.git"
        git fetch upstream ${{ env.SOURCE_BRANCH_NAME }}
        git merge --no-commit --no-ff upstream/${{ env.SOURCE_BRANCH_NAME }}

    - name: Checkout OpenCV contrib
      uses: actions/checkout@v4
      with:
        repository: opencv/opencv_contrib
        ref: ${{ env.TARGET_BRANCH_NAME }}
        path: /tmp/opencv_contrib

    - name: Merge opencv_contrib with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        if curl -s -I "https://github.com/${{ env.PR_AUTHOR }}/opencv_contrib" | head -n 1 | grep -q "200"; then
          cd /tmp/opencv_contrib
          git remote add upstream "https://github.com/${{ env.PR_AUTHOR }}/opencv_contrib.git"
          git fetch upstream ${{ env.SOURCE_BRANCH_NAME }}
          git merge --no-commit --no-ff upstream/${{ env.SOURCE_BRANCH_NAME }} 2>/dev/null || echo "No matching branch in opencv_contrib"
        else
          echo "opencv_contrib fork not found for PR author"
        fi

    - name: Configure OpenCV with contrib
      timeout-minutes: 30
      run: |
        cd /tmp/build
        cmake -G Ninja \
          -S /tmp/opencv \
          -B . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DOPENCV_EXTRA_MODULES_PATH=/tmp/opencv_contrib/modules \
          ${{ env.EXTRA_CMAKE_OPTIONS }}

    - name: Build OpenCV with contrib
      timeout-minutes: 120
      run: |
        cd /tmp/build
        ninja -j$(nproc) 2>&1 | tee build-log.txt

    - name: Warnings check
      timeout-minutes: 10
      run: |
        if [ -f /tmp/build/build-log.txt ]; then
          grep -i "warning:" /tmp/build/build-log.txt | head -20 || true
        fi




