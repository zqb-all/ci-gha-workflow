name: OCV PR:4.x RISC-V native

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/OCV-PR-4.x-RISCV-native.yaml'
  workflow_call:

concurrency:
  group: OCV-PR-4.x-RISCV-${{ github.ref }}
  cancel-in-progress: true

env:
  EXTRA_CMAKE_OPTIONS: '-DBUILD_EXAMPLES=ON -DOPENCV_ENABLE_NONFREE=ON -DCPU_BASELINE=RVV -DCPU_BASELINE_REQUIRE=RVV -DRISCV_RVV_SCALABLE=ON'
  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
  PR_AUTHOR_FORK: ${{ github.event.pull_request.head.repo.full_name }}
  SOURCE_BRANCH_NAME: ${{ github.head_ref }}
  TARGET_BRANCH_NAME: ${{ github.base_ref }}
  CCACHE_DIR: '.ccache'
  OPENCV_DOWNLOAD_PATH: 'binaries_cache'
  OPENCV_TEST_DATA_PATH: 'opencv_extra/testdata'
  OPENCV_CONTRIB_PATH: 'opencv_contrib'
  OPENCV_PATH: 'opencv'
  BUILD_PATH: 'build'
  PYTHONPATH: 'build/python_loader:$PYTHONPATH'
  EXTRA_GTEST_OPTIONS: '--skip_unstable=1'
  GIT_COMMITTER_NAME: 'nouser'
  GIT_COMMITTER_EMAIL: 'noemail'

jobs:
  BuildAndTest:
    runs-on: [self-hosted, riscv64, linux]

    defaults:
      run:
        shell: bash

    steps:
    - name: Install prerequisites
      timeout-minutes: 30
      run: |
        sudo apt-get update || true
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          cmake \
          ninja-build \
          ccache \
          git \
          wget \
          unzip \
          python3 \
          python3-dev \
          python3-numpy \
          libgtk2.0-dev \
          pkg-config \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev \
          libtbb-dev \
          libeigen3-dev \
          libopenblas-dev \
          liblapack-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer1.0-dev \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          libopenexr-dev \
          libwebp-dev \
          libopenjp2-7-dev \
          libgtk-3-dev \
          gcc-14 \
          g++-14
        sudo sh -c 'cd /usr/bin && \
          rm -f gcc && \
          ln -s gcc-14 gcc && \
          rm -f g++ && \
          ln -s g++-14 g++ && \
          rm -f gcc-ar && \
          ln -s gcc-ar-14 gcc-ar && \
          rm -f gcc-nm && \
          ln -s gcc-nm-14 gcc-nm && \
          rm -f gcc-ranlib && \
          ln -s gcc-ranlib-14 gcc-ranlib && \
          rm -f riscv64-linux-gnu-gcc && \
          ln -s riscv64-linux-gnu-gcc-14 riscv64-linux-gnu-gcc && \
          rm -f riscv64-linux-gnu-g++ && \
          ln -s riscv64-linux-gnu-g++-14 riscv64-linux-gnu-g++'

    - name: Brief system information
      timeout-minutes: 5
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== CPU Information ==="
        cat /proc/cpuinfo
        echo "=== Memory Information ==="
        free -h
        echo "=== Disk Information ==="
        df -h
        echo "=== Current Directory ==="
        pwd
        ls -la

    - name: Setup environment
      timeout-minutes: 5
      run: |
        mkdir -p ${{ env.CCACHE_DIR }}
        mkdir -p ${{ env.OPENCV_DOWNLOAD_PATH }}
        mkdir -p ${{ env.BUILD_PATH }}

    - name: Setup infra environment
      timeout-minutes: 5
      if: ${{ github.event.repository.name == 'ci-gha-workflow' }}
      run: |
        echo "TARGET_BRANCH_NAME=4.x" >> $GITHUB_ENV

    - name: PR info
      timeout-minutes: 5
      run: |
        echo "PR Author: ${{ env.PR_AUTHOR }}"
        echo "PR Author fork: ${{ env.PR_AUTHOR_FORK }}"
        echo "Source branch name: ${{ env.SOURCE_BRANCH_NAME }}"
        echo "Target branch name: ${{ env.TARGET_BRANCH_NAME }}"
        echo "Workspace: ${{ github.workspace }}"

    - name: Clean workspace
      timeout-minutes: 5
      run: |
        # 清理旧的构建
        rm -rf ${{ env.BUILD_PATH }}/*
        # 清理opencv目录（如果需要）
        if [ -d "${{ env.OPENCV_PATH }}/.git" ]; then
          echo "OpenCV directory exists, cleaning..."
          cd ${{ env.OPENCV_PATH }}
          git clean -fdx
          git reset --hard
        fi

    - name: Clone OpenCV
      timeout-minutes: 10
      run: |
        if [ -d "${{ env.OPENCV_PATH }}/.git" ]; then
          echo "Updating existing OpenCV repository..."
          cd ${{ env.OPENCV_PATH }}
          git fetch origin
          git checkout ${{ env.TARGET_BRANCH_NAME }}
          git reset --hard origin/${{ env.TARGET_BRANCH_NAME }}
        else
          echo "Cloning OpenCV repository..."
          git clone \
            --depth 1 \
            --branch ${{ env.TARGET_BRANCH_NAME }} \
            https://github.com/zqb-all/opencv.git \
            ${{ env.OPENCV_PATH }}
        fi

    - name: Merge with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd ${{ env.OPENCV_PATH }}
        echo "Fetching PR branch..."
        git fetch https://github.com/${{ env.PR_AUTHOR_FORK }}.git ${{ env.SOURCE_BRANCH_NAME }}
        echo "Merging PR changes..."
        git merge --no-commit --no-ff FETCH_HEAD

    - name: Clone OpenCV extra
      timeout-minutes: 10
      run: |
        if [ -d "opencv_extra/.git" ]; then
          echo "Updating existing OpenCV extra repository..."
          cd opencv_extra
          git fetch origin
          git checkout ${{ env.TARGET_BRANCH_NAME }}
          git reset --hard origin/${{ env.TARGET_BRANCH_NAME }}
        else
          echo "Cloning OpenCV extra repository..."
          git clone \
            --depth 1 \
            --branch ${{ env.TARGET_BRANCH_NAME }} \
            https://github.com/opencv/opencv_extra.git
        fi

    - name: Merge opencv_extra with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd opencv_extra
        # 检查PR作者是否有opencv_extra的分支
        if git ls-remote --heads "https://github.com/${{ env.PR_AUTHOR }}/opencv_extra" "${{ env.SOURCE_BRANCH_NAME }}" | grep -q "refs/heads"; then
          echo "Merging opencv_extra with PR branch..."
          git fetch https://github.com/${{ env.PR_AUTHOR }}/opencv_contrib.git ${{ env.SOURCE_BRANCH_NAME }}
          git merge --no-commit --no-ff FETCH_HEAD || echo "Merge failed or no changes"
        else
          echo "No matching branch in opencv_extra fork, using main repo"
        fi

    - name: Configure OpenCV
      timeout-minutes: 30
      run: |
        cd ${{ env.BUILD_PATH }}
        cmake -G Ninja \
          -S ../${{ env.OPENCV_PATH }} \
          -B . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DBUILD_PERF_TESTS=ON \
          -DWITH_OPENCL=OFF \
          -DWITH_CUDA=OFF \
          ${{ env.EXTRA_CMAKE_OPTIONS }}

    - name: Build OpenCV
      timeout-minutes: 120
      id: build-opencv
      run: |
        cd ${{ env.BUILD_PATH }}
        ninja -j$(nproc) 2>&1 | tee build-log.txt

    - name: Warnings check
      timeout-minutes: 10
      run: |
        if [ -f "${{ env.BUILD_PATH }}/build-log.txt" ]; then
          echo "=== Build Warnings (first 20) ==="
          grep -i "warning:" ${{ env.BUILD_PATH }}/build-log.txt | head -20 || echo "No warnings found"
        fi

    - name: Accuracy:core
      timeout-minutes: 90
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd ${{ env.BUILD_PATH }}
        OPENCV_TEST_DATA_PATH=../opencv_extra/testdata ./bin/opencv_test_core \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*

    - name: Accuracy:imgproc
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd ${{ env.BUILD_PATH }}
        OPENCV_TEST_DATA_PATH=../opencv_extra/testdata ./bin/opencv_test_imgproc \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*:-Imgproc_Hist_Compare.accuracy

    - name: Accuracy:dnn
      timeout-minutes: 60
      if: ${{ always() && steps.build-opencv.outcome == 'success' }}
      run: |
        cd ${{ env.BUILD_PATH }}
        OPENCV_TEST_DATA_PATH=../opencv_extra/testdata ./bin/opencv_test_dnn \
          ${{ env.EXTRA_GTEST_OPTIONS }} \
          --gtest_filter=*

  BuildContrib:
    runs-on: [self-hosted, riscv64, linux]

    defaults:
      run:
        shell: bash

    steps:
    - name: Install prerequisites
      timeout-minutes: 30
      run: |
        sudo apt-get update || true
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          cmake \
          ninja-build \
          ccache \
          git \
          wget \
          unzip \
          python3 \
          python3-dev \
          python3-numpy \
          libgtk2.0-dev \
          pkg-config \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev \
          gcc-14 \
          g++-14
        sudo sh -c 'cd /usr/bin && \
          rm -f gcc && \
          ln -s gcc-14 gcc && \
          rm -f g++ && \
          ln -s g++-14 g++ && \
          rm -f gcc-ar && \
          ln -s gcc-ar-14 gcc-ar && \
          rm -f gcc-nm && \
          ln -s gcc-nm-14 gcc-nm && \
          rm -f gcc-ranlib && \
          ln -s gcc-ranlib-14 gcc-ranlib && \
          rm -f riscv64-linux-gnu-gcc && \
          ln -s riscv64-linux-gnu-gcc-14 riscv64-linux-gnu-gcc && \
          rm -f riscv64-linux-gnu-g++ && \
          ln -s riscv64-linux-gnu-g++-14 riscv64-linux-gnu-g++'

    - name: Brief system information
      timeout-minutes: 5
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== CPU Information ==="
        cat /proc/cpuinfo
        echo "=== Memory Information ==="
        free -h
        echo "=== Current Directory ==="
        pwd

    - name: Setup environment
      timeout-minutes: 5
      run: |
        mkdir -p ${{ env.CCACHE_DIR }}
        mkdir -p ${{ env.BUILD_PATH }}

    - name: Setup infra environment
      timeout-minutes: 5
      if: ${{ github.event.repository.name == 'ci-gha-workflow' }}
      run: |
        echo "TARGET_BRANCH_NAME=4.x" >> $GITHUB_ENV

    - name: PR info
      timeout-minutes: 5
      run: |
        echo "PR Author: ${{ env.PR_AUTHOR }}"
        echo "PR Author fork: ${{ env.PR_AUTHOR_FORK }}"
        echo "Source branch name: ${{ env.SOURCE_BRANCH_NAME }}"
        echo "Target branch name: ${{ env.TARGET_BRANCH_NAME }}"

    - name: Clean workspace
      timeout-minutes: 5
      run: |
        # 清理旧的构建
        rm -rf ${{ env.BUILD_PATH }}/*
        # 清理opencv目录（如果需要）
        if [ -d "${{ env.OPENCV_PATH }}/.git" ]; then
          echo "OpenCV directory exists, cleaning..."
          cd ${{ env.OPENCV_PATH }}
          git clean -fdx
          git reset --hard
        fi

    - name: Clone OpenCV
      timeout-minutes: 10
      run: |
        if [ -d "${{ env.OPENCV_PATH }}/.git" ]; then
          echo "Updating existing OpenCV repository..."
          cd ${{ env.OPENCV_PATH }}
          git fetch origin
          git checkout ${{ env.TARGET_BRANCH_NAME }}
          git reset --hard origin/${{ env.TARGET_BRANCH_NAME }}
        else
          echo "Cloning OpenCV repository..."
          git clone \
            --depth 1 \
            --branch ${{ env.TARGET_BRANCH_NAME }} \
            https://github.com/zqb-all/opencv.git \
            ${{ env.OPENCV_PATH }}
        fi

    - name: Merge with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd ${{ env.OPENCV_PATH }}
        echo "Fetching PR branch..."
        git fetch https://github.com/${{ env.PR_AUTHOR_FORK }}.git ${{ env.SOURCE_BRANCH_NAME }}
        echo "Merging PR changes..."
        git merge --no-commit --no-ff FETCH_HEAD

    - name: Clone OpenCV contrib
      timeout-minutes: 10
      run: |
        if [ -d "${{ env.OPENCV_CONTRIB_PATH }}/.git" ]; then
          echo "Updating existing OpenCV contrib repository..."
          cd ${{ env.OPENCV_CONTRIB_PATH }}
          git fetch origin
          git checkout ${{ env.TARGET_BRANCH_NAME }}
          git reset --hard origin/${{ env.TARGET_BRANCH_NAME }}
        else
          echo "Cloning OpenCV contrib repository..."
          git clone \
            --depth 1 \
            --branch ${{ env.TARGET_BRANCH_NAME }} \
            https://github.com/opencv/opencv_contrib.git \
            ${{ env.OPENCV_CONTRIB_PATH }}
        fi

    - name: Merge opencv_contrib with PR branch
      timeout-minutes: 5
      if: ${{ github.event.repository.name != 'ci-gha-workflow' }}
      run: |
        cd ${{ env.OPENCV_CONTRIB_PATH }}
        # 检查PR作者是否有opencv_contrib的分支
        if git ls-remote --heads "https://github.com/${{ env.PR_AUTHOR }}/opencv_contrib" "${{ env.SOURCE_BRANCH_NAME }}" | grep -q "refs/heads"; then
          echo "Merging opencv_contrib with PR branch..."
          git fetch https://github.com/${{ env.PR_AUTHOR }}/opencv_contrib.git ${{ env.SOURCE_BRANCH_NAME }}
          git merge --no-commit --no-ff FETCH_HEAD || echo "Merge failed or no changes"
        else
          echo "No matching branch in opencv_contrib fork, using main repo"
        fi

    - name: Configure OpenCV with contrib
      timeout-minutes: 30
      run: |
        cd ${{ env.BUILD_PATH }}
        cmake -G Ninja \
          -S ../${{ env.OPENCV_PATH }} \
          -B . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DOPENCV_EXTRA_MODULES_PATH=../${{ env.OPENCV_CONTRIB_PATH }}/modules \
          ${{ env.EXTRA_CMAKE_OPTIONS }}

    - name: Build OpenCV with contrib
      timeout-minutes: 120
      run: |
        cd ${{ env.BUILD_PATH }}
        ninja -j$(nproc) 2>&1 | tee build-log.txt

    - name: Warnings check
      timeout-minutes: 10
      run: |
        if [ -f "${{ env.BUILD_PATH }}/build-log.txt" ]; then
          echo "=== Build Warnings (first 20) ==="
          grep -i "warning:" ${{ env.BUILD_PATH }}/build-log.txt | head -20 || echo "No warnings found"
        fi

